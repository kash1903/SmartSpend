<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Expenses | Smart Expense Tracker</title>
  <link href="/css/tailwind.css" rel="stylesheet" />
</head>

<body class="min-h-screen bg-gradient-to-br from-indigo-100 via-purple-100 to-pink-100 flex flex-col">

  <!-- Navbar -->
  <nav class="flex justify-between items-center px-8 py-4 bg-white/70 backdrop-blur-md shadow-md">
    <h1 class="text-2xl font-bold text-indigo-600">üí∞ Smart Expense Tracker</h1>
    <div class="space-x-4">
      <a href="/dashboard" class="text-gray-700 hover:text-indigo-600 font-medium">Dashboard</a>
      <a href="/" class="text-gray-700 hover:text-indigo-600 font-medium">Logout</a>
    </div>
  </nav>

  <!-- Main Section -->
  <main class="flex-grow p-8">
    <div class="flex justify-between items-center mb-6">
      <h2 class="text-3xl font-bold text-indigo-700">Your Expenses üßæ</h2>
      <button id="addExpenseBtn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg shadow hover:bg-indigo-700 transition">
        ‚ûï Add Expense
      </button>
    </div>

    <!-- hidden model for expense adding  -->
     <!-- Add Expense Modal (hidden by default) -->
<div id="expenseModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
  <div class="bg-white rounded-2xl shadow-xl w-full max-w-lg p-6 relative">
    <h2 class="text-2xl font-bold mb-4 text-indigo-700">‚ûï Add Expense</h2>

    <form id="expenseForm" class="space-y-4">
      <div>
        <label class="block text-gray-700 font-medium mb-1">Title</label>
        <input type="text" id="expenseTitle" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-400 outline-none" placeholder="e.g. Medical Shopping">
      </div>

      <div>
        <label class="block text-gray-700 font-medium mb-1">Category</label>
        <input type="text" id="expenseCategory" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-400 outline-none" placeholder="e.g. Health, Food">
      </div>

      <div>
        <label class="block text-gray-700 font-medium mb-1">Type</label>
        <select id="expenseType" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-400 outline-none">
          <option value="EXPENSE">EXPENSE</option>
          <option value="INCOME">INCOME</option>
        </select>
      </div>

      <div>
        <label class="block text-gray-700 font-medium mb-1">Amount</label>
        <input type="number" id="expenseAmount" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-400 outline-none" placeholder="e.g. 500">
      </div>

      <div>
        <label class="block text-gray-700 font-medium mb-1">Date</label>
        <input type="date" id="expenseDate" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-400 outline-none">
      </div>

      <div>
        <label class="block text-gray-700 font-medium mb-1">Description</label>
        <textarea id="expenseDescription" rows="3" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-400 outline-none" placeholder="Optional"></textarea>
      </div>

      <div class="flex justify-end gap-3 mt-4">
        <button type="button" id="closeModal" class="px-4 py-2 rounded-lg bg-gray-300 hover:bg-gray-400">Cancel</button>
        <button type="submit" class="px-4 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700">Add</button>
      </div>
    </form>
  </div>
</div>

    <!-- hidden model for expense adding  -->

    <!-- Hidden model for Edit Expense start -->
<!-- Edit Expense Modal (hidden by default) -->
<div id="editExpenseModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
  <div class="bg-white rounded-2xl shadow-xl w-full max-w-lg p-6 relative">
    <h2 class="text-2xl font-bold mb-4 text-indigo-700">‚úèÔ∏è Edit Expense</h2>

    <form id="editExpenseForm" class="space-y-4">
      <input type="hidden" id="editExpenseId">
      
      <div>
        <label class="block text-gray-700 font-medium mb-1">Title</label>
        <input type="text" id="editExpenseTitle" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-400 outline-none">
      </div>

      <div>
        <label class="block text-gray-700 font-medium mb-1">Category</label>
        <input type="text" id="editExpenseCategory" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-400 outline-none">
      </div>

      <div>
        <label class="block text-gray-700 font-medium mb-1">Type</label>
        <select id="editExpenseType" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-400 outline-none">
          <option value="EXPENSE">EXPENSE</option>
          <option value="INCOME">INCOME</option>
        </select>
      </div>

      <div>
        <label class="block text-gray-700 font-medium mb-1">Amount</label>
        <input type="number" id="editExpenseAmount" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-400 outline-none">
      </div>

      <div>
        <label class="block text-gray-700 font-medium mb-1">Date</label>
        <input type="date" id="editExpenseDate" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-400 outline-none">
      </div>

      <div>
        <label class="block text-gray-700 font-medium mb-1">Description</label>
        <textarea id="editExpenseDescription" rows="3" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-400 outline-none"></textarea>
      </div>

      <div class="flex justify-end gap-3 mt-4">
        <button type="button" id="closeEditModal" class="px-4 py-2 rounded-lg bg-gray-300 hover:bg-gray-400">Cancel</button>
        <button type="submit" class="px-4 py-2 rounded-lg bg-yellow-500 text-white hover:bg-yellow-600">Update</button>
      </div>
    </form>
  </div>
</div>

    <!-- Hidden model for Edit Expense end -->

    <!-- Expense Table -->
    <div class="overflow-x-auto bg-white/90 backdrop-blur-md rounded-2xl shadow-xl p-6">
      <table class="min-w-full border border-gray-200 rounded-lg">
        <thead class="bg-indigo-600 text-white">
          <tr>
            <th class="py-3 px-4 text-left">ID</th>
            <th class="py-3 px-4 text-left">Title</th>
            <th class="py-3 px-4 text-left">Category</th>
            <th class="py-3 px-4 text-left">Amount</th>
            <th class="py-3 px-4 text-left">Date</th>
            <th class="py-3 px-4 text-left">Description</th>
            <th class="py-3 px-4 text-left">Actions</th>
          </tr>
        </thead>
        <tbody id="expenseTable" class="divide-y divide-gray-200 text-gray-700">
          <!-- Data will be dynamically added here -->
        </tbody>
      </table>
    </div>
  </main>

  <footer class="text-center py-4 text-gray-600 text-sm">
    ¬© 2025 Smart Expense Tracker ‚Äî All rights reserved.
  </footer>

<script>
    document.addEventListener("DOMContentLoaded", async () => {
  const userId = localStorage.getItem("userId");
  if (!userId) {
    alert("Please log in first!");
    window.location.href = "/login";
    return;
  }

  const tableBody = document.getElementById("expenseTable");

  async function loadExpenses() {
    const response = await fetch(`http://localhost:8080/api/expenses/user/${userId}`);
    const data = await response.json();

    tableBody.innerHTML = "";
    data.forEach(expense => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td class="py-3 px-4">${expense.id}</td>
        <td class="py-3 px-4 font-semibold">${expense.title}</td>
        <td class="py-3 px-4">${expense.category}</td>
        <td class="py-3 px-4">‚Çπ${expense.amount}</td>
        <td class="py-3 px-4">${expense.date}</td>
        <td class="py-3 px-4">${expense.description}</td>
        <td class="py-3 px-4">
          <button class="editBtn bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded-md mr-2">‚úèÔ∏è Edit</button>
          <button class="deleteBtn bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-md">üóëÔ∏è Delete</button>
        </td>
      `;
      tableBody.appendChild(row);

      // Edit Button
      row.querySelector(".editBtn").addEventListener("click", () => openEditModal(expense));

      // Delete Button
      row.querySelector(".deleteBtn").addEventListener("click", () => deleteExpense(expense.id));
    });
  }

  await loadExpenses();

  // --- Add Expense Modal (existing code) ---
  const modal = document.getElementById("expenseModal");
  const addBtn = document.getElementById("addExpenseBtn");
  const closeModal = document.getElementById("closeModal");
  const form = document.getElementById("expenseForm");

  addBtn.addEventListener("click", () => modal.classList.remove("hidden"));
  closeModal.addEventListener("click", () => { modal.classList.add("hidden"); form.reset(); });

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const expenseData = {
      title: document.getElementById("expenseTitle").value,
      category: document.getElementById("expenseCategory").value,
      type: document.getElementById("expenseType").value,
      amount: parseFloat(document.getElementById("expenseAmount").value),
      date: document.getElementById("expenseDate").value,
      description: document.getElementById("expenseDescription").value
    };

    try {
      const res = await fetch(`http://localhost:8080/api/expenses/add/${userId}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(expenseData)
      });
      const result = await res.text();
      if (res.ok) {
        alert(result);
        form.reset();
        modal.classList.add("hidden");
        loadExpenses();
      } else {
        alert("Error: " + result);
      }
    } catch (err) { console.error(err); alert("‚ö†Ô∏è Could not connect to server."); }
  });

  // --- Edit Expense Modal ---
  const editModal = document.getElementById("editExpenseModal");
  const editForm = document.getElementById("editExpenseForm");
  const closeEditModalBtn = document.getElementById("closeEditModal");

  function openEditModal(expense) {
    editModal.classList.remove("hidden");
    document.getElementById("editExpenseId").value = expense.id;
    document.getElementById("editExpenseTitle").value = expense.title;
    document.getElementById("editExpenseCategory").value = expense.category;
    document.getElementById("editExpenseType").value = expense.type;
    document.getElementById("editExpenseAmount").value = expense.amount;
    document.getElementById("editExpenseDate").value = expense.date;
    document.getElementById("editExpenseDescription").value = expense.description;
  }

  closeEditModalBtn.addEventListener("click", () => {
    editModal.classList.add("hidden");
    editForm.reset();
  });

  editForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const expenseId = document.getElementById("editExpenseId").value;

    const updatedExpense = {
      title: document.getElementById("editExpenseTitle").value,
      category: document.getElementById("editExpenseCategory").value,
      type: document.getElementById("editExpenseType").value,
      amount: parseFloat(document.getElementById("editExpenseAmount").value),
      date: document.getElementById("editExpenseDate").value,
      description: document.getElementById("editExpenseDescription").value
    };

    try {
      const res = await fetch(`http://localhost:8080/api/expenses/update/${expenseId}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(updatedExpense)
      });
      const result = await res.text();
      if (res.ok) {
        alert(result);
        editForm.reset();
        editModal.classList.add("hidden");
        loadExpenses();
      } else {
        alert("Error: " + result);
      }
    } catch (err) { console.error(err); alert("‚ö†Ô∏è Could not connect to server."); }
  });

  // --- Delete Expense ---
  async function deleteExpense(expenseId) {
    if (!confirm("Are you sure you want to delete this expense?")) return;
    try {
      const res = await fetch(`http://localhost:8080/api/expenses/delete/${expenseId}`, {
        method: "DELETE"
      });
      const result = await res.text();
      if (res.ok) {
        alert(result);
        loadExpenses();
      } else {
        alert("Error: " + result);
      }
    } catch (err) {
      console.error(err);
      alert("‚ö†Ô∏è Could not connect to server.");
    }
  }

});

</script>


</body>
</html>
